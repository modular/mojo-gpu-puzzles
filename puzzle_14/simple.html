<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>üî∞ Simple Version - Mojo üî• GPU Puzzles</title>


        <!-- Custom HTML head -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap"
            rel="stylesheet">
        
        <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
        
        <link rel="stylesheet" href="../theme/css/custom.css">
        <link rel="stylesheet" href="../theme/css/highlight.css">
        <link rel="stylesheet" id="theme">
        
        <!-- Additional meta tags -->
        <meta property="og:title" content="Mojoüî• GPU Puzzles">
        <meta property="og:description" content="Learn GPU Programming in Mojoüî• Through Interactive Puzzles">
        <meta property="og:image" content="https://puzzles.modular.com/puzzles_images/puzzle-mark.png">
        <meta property="og:url" content="https://puzzles.modular.com/">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:image:alt" content="Mojo GPU Puzzles Logo">
        <meta name="twitter:title" content="Mojoüî• GPU Puzzles">
        <meta name="twitter:description" content="Learn GPU Programming in Mojoüî• Through Interactive Puzzles">
        <meta name="twitter:image" content="https://puzzles.modular.com/puzzles_images/puzzle-mark.png">
        <link rel="icon" type="image/png" href="https://puzzles.modular.com/puzzles_images/puzzle-mark.png">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/css/custom.css">
        <link rel="stylesheet" href="../theme/css/highlight.css">
        <link rel="stylesheet" href="../theme/css/tabs.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <button class="collapse-sidebar" aria-label="Collapse sidebar"></button>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Toggle color mode and talk to us buttons -->
        <script>
            document.addEventListener('click', function (event) {
                if (!event.target.matches('.theme-toggle')) return;
                event.preventDefault();
                const prevTheme = theme;
                html.classList.remove(theme);
                const newTheme = prevTheme === 'ayu' ? 'light' : 'ayu'
                html.classList.add(newTheme);
                theme = newTheme
                localStorage.setItem('mdbook-theme', theme);
            }, false);
            document.addEventListener('click', function() {
                if (!event.target.matches('.log-in')) return;
                event.preventDefault();
                window.amplitude.logEvent('LoginClickedFromPuzzles');
                window.open('https://developer.modular.com', '_blank');
            });
        </script>

        <div class="page-header">
            <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                <i class="fa fa-bars"></i>
            </label>
            <div id="menu-bar" class="menu-bar">
                <div class="left-buttons">
                    <div class="logo-section">
                        <a class="desktop-logo-link" href="https://modular.com"></a>
                        <a class="mobile-logo-link" href="https://builds.modular.com"></a>
                        <div class="slash">/</div>
                        <a class="internal-link" ref="/">Puzzles</a>
                    </div>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Dark</button></li>
                        </ul>
                    </div>
                <div class="right-buttons">
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button theme-toggle-btn" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="false" aria-expanded="false">
                        <i class="theme-toggle"></i>
                    </button>
                    <a class="menu-btn print" href="../print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a class="menu-btn" href="https://github.com/modular/mojo-gpu-puzzles" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>
                </div>
            </div>
        </div>

        <div id="page-wrapper" class="page-wrapper">
            <div class="page">

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <div id="content" class="content">
                    <main>
                        <h1 id="simple-version"><a class="header" href="#simple-version">Simple Version</a></h1>
<p>Implement a kernel that computes a prefix-sum over 1D LayoutTensor <code>a</code> and stores it in 1D LayoutTensor <code>output</code>.</p>
<p><strong>Note:</strong> <em>If the size of <code>a</code> is greater than the block size, only store the sum of each block.</em></p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<ul>
<li>Array size: <code>SIZE = 8</code> elements</li>
<li>Threads per block: <code>TPB = 8</code></li>
<li>Number of blocks: 1</li>
<li>Shared memory: <code>TPB</code> elements</li>
</ul>
<p>Notes:</p>
<ul>
<li><strong>Data loading</strong>: Each thread loads one element using LayoutTensor access</li>
<li><strong>Memory pattern</strong>: Shared memory for intermediate results using <code>LayoutTensorBuild</code></li>
<li><strong>Thread sync</strong>: Coordination between computation phases</li>
<li><strong>Access pattern</strong>: Stride-based parallel computation</li>
<li><strong>Type safety</strong>: Leveraging LayoutTensor‚Äôs type system</li>
</ul>
<h2 id="code-to-complete"><a class="header" href="#code-to-complete">Code to complete</a></h2>
<pre><code class="language-mojo">alias TPB = 8
alias SIZE = 8
alias BLOCKS_PER_GRID = (1, 1)
alias THREADS_PER_BLOCK = (TPB, 1)
alias dtype = DType.float32
alias layout = Layout.row_major(SIZE)


fn prefix_sum_simple[
    layout: Layout
](
    output: LayoutTensor[mut=False, dtype, layout],
    a: LayoutTensor[mut=False, dtype, layout],
    size: Int,
):
    global_i = block_dim.x * block_idx.x + thread_idx.x
    local_i = thread_idx.x
    # FILL ME IN (roughly 18 lines)


</code></pre>
<p><a href="https://github.com/modular/mojo-gpu-puzzles/blob/main/problems/p14/p14.mojo" class="filename">View full file: problems/p14/p14.mojo</a></p>
<details>
<summary><strong>Tips</strong></summary>
<div class="solution-tips">
<ol>
<li>Load data into <code>shared[local_i]</code></li>
<li>Use <code>offset = 1</code> and double it each step</li>
<li>Add elements where <code>local_i &gt;= offset</code></li>
<li>Call <code>barrier()</code> between steps</li>
</ol>
</div>
</details>
<h3 id="running-the-code"><a class="header" href="#running-the-code">Running the code</a></h3>
<p>To test your solution, run the following command in your terminal:</p>
<div class="code-tabs" data-tab-group="package-manager">
  <div class="tab-buttons">
    <button class="tab-button">pixi NVIDIA (default)</button>
    <button class="tab-button">pixi AMD</button>
    <button class="tab-button">pixi Apple</button>
    <button class="tab-button">uv</button>
  </div>
  <div class="tab-content">
<pre><code class="language-bash">pixi run p14 --simple
</code></pre>
  </div>
  <div class="tab-content">
<pre><code class="language-bash">pixi run p14 --simple -e amd
</code></pre>
  </div>
  <div class="tab-content">
<pre><code class="language-bash">pixi run p14 --simple -e apple
</code></pre>
  </div>
  <div class="tab-content">
<pre><code class="language-bash">uv run poe p14 --simple
</code></pre>
  </div>
</div>
<p>Your output will look like this if the puzzle isn‚Äôt solved yet:</p>
<pre><code class="language-txt">out: DeviceBuffer([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0])
expected: HostBuffer([0.0, 1.0, 3.0, 6.0, 10.0, 15.0, 21.0, 28.0])
</code></pre>
<h2 id="solution"><a class="header" href="#solution">Solution</a></h2>
<details class="solution-details">
<summary></summary>
<pre><code class="language-mojo">fn prefix_sum_simple[
    layout: Layout
](
    output: LayoutTensor[mut=False, dtype, layout],
    a: LayoutTensor[mut=False, dtype, layout],
    size: Int,
):
    global_i = block_dim.x * block_idx.x + thread_idx.x
    local_i = thread_idx.x
    shared = tb[dtype]().row_major[TPB]().shared().alloc()
    if global_i &lt; size:
        shared[local_i] = a[global_i]

    barrier()

    offset = 1
    for i in range(Int(log2(Scalar[dtype](TPB)))):
        var current_val: output.element_type = 0
        if local_i &gt;= offset and local_i &lt; size:
            current_val = shared[local_i - offset]  # read

        barrier()
        if local_i &gt;= offset and local_i &lt; size:
            shared[local_i] += current_val

        barrier()
        offset *= 2

    if global_i &lt; size:
        output[global_i] = shared[local_i]


</code></pre>
<div class="solution-explanation">
<p>The parallel (inclusive) prefix-sum algorithm works as follows:</p>
<h3 id="setup--configuration"><a class="header" href="#setup--configuration">Setup &amp; Configuration</a></h3>
<ul>
<li><code>TPB</code> (Threads Per Block) = 8</li>
<li><code>SIZE</code> (Array Size) = 8</li>
</ul>
<h3 id="race-condition-prevention"><a class="header" href="#race-condition-prevention">Race condition prevention</a></h3>
<p>The algorithm uses explicit synchronization to prevent read-write hazards:</p>
<ul>
<li><strong>Read Phase</strong>: All threads first read the values they need into a local variable <code>current_val</code></li>
<li><strong>Synchronization</strong>: <code>barrier()</code> ensures all reads complete before any writes begin</li>
<li><strong>Write Phase</strong>: All threads then safely write their computed values back to shared memory</li>
</ul>
<p>This prevents the race condition that would occur if threads simultaneously read from and write to the same shared memory locations.</p>
<p><strong>Alternative approach</strong>: Another solution to prevent race conditions is through <em>double buffering</em>, where you allocate twice the shared memory and alternate between reading from one buffer and writing to another. While this approach eliminates race conditions completely, it requires more shared memory and adds complexity. For educational purposes, we use the explicit synchronization approach as it‚Äôs more straightforward to understand.</p>
<h3 id="thread-mapping"><a class="header" href="#thread-mapping">Thread mapping</a></h3>
<ul>
<li><code>thread_idx.x</code>: \([0, 1, 2, 3, 4, 5, 6, 7]\) (<code>local_i</code>)</li>
<li><code>block_idx.x</code>: \([0, 0, 0, 0, 0, 0, 0, 0]\)</li>
<li><code>global_i</code>: \([0, 1, 2, 3, 4, 5, 6, 7]\) (<code>block_idx.x * TPB + thread_idx.x</code>)</li>
</ul>
<h3 id="initial-load-to-shared-memory"><a class="header" href="#initial-load-to-shared-memory">Initial load to shared memory</a></h3>
<pre><code class="language-txt">Threads:      T‚ÇÄ   T‚ÇÅ   T‚ÇÇ   T‚ÇÉ   T‚ÇÑ   T‚ÇÖ   T‚ÇÜ   T‚Çá
Input array:  [0    1    2    3    4    5    6    7]
shared:       [0    1    2    3    4    5    6    7]
               ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë
              T‚ÇÄ   T‚ÇÅ   T‚ÇÇ   T‚ÇÉ   T‚ÇÑ   T‚ÇÖ   T‚ÇÜ   T‚Çá
</code></pre>
<h3 id="offset--1-first-parallel-step"><a class="header" href="#offset--1-first-parallel-step">Offset = 1: First Parallel Step</a></h3>
<p>Active threads: \(T_1 \ldots T_7\) (where <code>local_i ‚â• 1</code>)</p>
<p><strong>Read Phase</strong>: Each thread reads the value it needs:</p>
<pre><code class="language-txt">T‚ÇÅ reads shared[0] = 0    T‚ÇÖ reads shared[4] = 4
T‚ÇÇ reads shared[1] = 1    T‚ÇÜ reads shared[5] = 5
T‚ÇÉ reads shared[2] = 2    T‚Çá reads shared[6] = 6
T‚ÇÑ reads shared[3] = 3
</code></pre>
<p><strong>Synchronization</strong>: <code>barrier()</code> ensures all reads complete</p>
<p><strong>Write Phase</strong>: Each thread adds its read value to its current position:</p>
<pre><code class="language-txt">Before:      [0    1    2    3    4    5    6    7]
Add:              +0   +1   +2   +3   +4   +5   +6
                   |    |    |    |    |    |    |
Result:      [0    1    3    5    7    9    11   13]
                   ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë
                  T‚ÇÅ   T‚ÇÇ   T‚ÇÉ   T‚ÇÑ   T‚ÇÖ   T‚ÇÜ   T‚Çá
</code></pre>
<h3 id="offset--2-second-parallel-step"><a class="header" href="#offset--2-second-parallel-step">Offset = 2: Second Parallel Step</a></h3>
<p>Active threads: \(T_2 \ldots T_7\) (where <code>local_i ‚â• 2</code>)</p>
<p><strong>Read Phase</strong>: Each thread reads the value it needs:</p>
<pre><code class="language-txt">T‚ÇÇ reads shared[0] = 0    T‚ÇÖ reads shared[3] = 5
T‚ÇÉ reads shared[1] = 1    T‚ÇÜ reads shared[4] = 7
T‚ÇÑ reads shared[2] = 3    T‚Çá reads shared[5] = 9
</code></pre>
<p><strong>Synchronization</strong>: <code>barrier()</code> ensures all reads complete</p>
<p><strong>Write Phase</strong>: Each thread adds its read value:</p>
<pre><code class="language-txt">Before:      [0    1    3    5    7    9    11   13]
Add:                   +0   +1   +3   +5   +7   +9
                        |    |    |    |    |    |
Result:      [0    1    3    6    10   14   18   22]
                        ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë
                       T‚ÇÇ   T‚ÇÉ   T‚ÇÑ   T‚ÇÖ   T‚ÇÜ   T‚Çá
</code></pre>
<h3 id="offset--4-third-parallel-step"><a class="header" href="#offset--4-third-parallel-step">Offset = 4: Third Parallel Step</a></h3>
<p>Active threads: \(T_4 \ldots T_7\) (where <code>local_i ‚â• 4</code>)</p>
<p><strong>Read Phase</strong>: Each thread reads the value it needs:</p>
<pre><code class="language-txt">T‚ÇÑ reads shared[0] = 0    T‚ÇÜ reads shared[2] = 3
T‚ÇÖ reads shared[1] = 1    T‚Çá reads shared[3] = 6
</code></pre>
<p><strong>Synchronization</strong>: <code>barrier()</code> ensures all reads complete</p>
<p><strong>Write Phase</strong>: Each thread adds its read value:</p>
<pre><code class="language-txt">Before:      [0    1    3    6    10   14   18   22]
Add:                              +0   +1   +3   +6
                                  |    |    |    |
Result:      [0    1    3    6    10   15   21   28]
                                  ‚Üë    ‚Üë    ‚Üë    ‚Üë
                                  T‚ÇÑ   T‚ÇÖ   T‚ÇÜ   T‚Çá
</code></pre>
<h3 id="final-write-to-output"><a class="header" href="#final-write-to-output">Final write to output</a></h3>
<pre><code class="language-txt">Threads:      T‚ÇÄ   T‚ÇÅ   T‚ÇÇ   T‚ÇÉ   T‚ÇÑ   T‚ÇÖ   T‚ÇÜ   T‚Çá
global_i:     0    1    2    3    4    5    6    7
output:       [0    1    3    6    10   15   21   28]
              ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë    ‚Üë
              T‚ÇÄ   T‚ÇÅ   T‚ÇÇ   T‚ÇÉ   T‚ÇÑ   T‚ÇÖ   T‚ÇÜ   T‚Çá
</code></pre>
<h3 id="key-implementation-details"><a class="header" href="#key-implementation-details">Key implementation details</a></h3>
<p><strong>Synchronization Pattern</strong>: Each iteration follows a strict read ‚Üí sync ‚Üí write pattern:</p>
<ol>
<li><code>var current_val: out.element_type = 0</code> - Initialize local variable</li>
<li><code>current_val = shared[local_i - offset]</code> - Read phase (if conditions met)</li>
<li><code>barrier()</code> - Explicit synchronization to prevent race conditions</li>
<li><code>shared[local_i] += current_val</code> - Write phase (if conditions met)</li>
<li><code>barrier()</code> - Standard synchronization before next iteration</li>
</ol>
<p><strong>Race Condition Prevention</strong>: Without the explicit read-write separation, multiple threads could simultaneously access the same shared memory location, leading to undefined behavior. The two-phase approach with explicit synchronization ensures correctness.</p>
<p><strong>Memory Safety</strong>: The algorithm maintains memory safety through:</p>
<ul>
<li>Bounds checking with <code>if local_i &gt;= offset and local_i &lt; size</code></li>
<li>Proper initialization of the temporary variable</li>
<li>Coordinated access patterns that prevent data races</li>
</ul>
<p>The solution ensures correct synchronization between phases using <code>barrier()</code> and handles array bounds checking with <code>if global_i &lt; size</code>. The final result produces the inclusive prefix sum where each element \(i\) contains \(\sum_{j=0}^{i} a[j]\).</p>
</div>
</details>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../puzzle_14/puzzle_14.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../puzzle_14/complete.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../puzzle_14/puzzle_14.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../puzzle_14/complete.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/mojolang.js"></script>
        <script src="../theme/sidebar.js"></script>
        <script src="../theme/solution.js"></script>
        <script src="../theme/init-amplitude.js"></script>
        <script src="../theme/tabs.js"></script>


    </div>
    </body>
</html>
